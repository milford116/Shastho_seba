"use strict";var mongoose=require("mongoose"),doctor=require("../models/doctor.model"),reference=require("../models/reference.model"),appointment=require("../models/appointment.model"),doctorModel=mongoose.model("doctor"),referenceModel=mongoose.model("reference"),appointmentModel=mongoose.model("appointment"),bcrypt=require("bcrypt"),jwt=require("jsonwebtoken"),_require=require("../errors"),SUCCESS=_require.SUCCESS,INTERNAL_SERVER_ERROR=_require.INTERNAL_SERVER_ERROR,BAD_REQUEST=_require.BAD_REQUEST,DATA_NOT_FOUND=_require.DATA_NOT_FOUND;exports.registration=function(t,s){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:doctorModel.findOne({mobile_no:t.body.mobile_no},function(e,n){n?s.status(BAD_REQUEST).send("An account with this mobile no. already exists"):referenceModel.findOneAndDelete({doctor:t.body.mobile_no},function(e,n){if(e)s.status(BAD_REQUEST).send("No referreral found for this mobile no");else{var o=new doctorModel;o.name=t.body.name,o.email=t.body.email,o.mobile_no=t.body.mobile_no,o.institution=t.body.institution,o.designation=t.body.designation,o.reg_number=t.body.reg_number,o.referrer=n.referrer;var r={mobile_no:o.mobile_no,name:o.name,reg_number:o.reg_number};o.session_token=jwt.sign(r,process.env.SECRET),bcrypt.hash(t.body.password,parseInt(process.env.SALT_ROUNDS,10),function(e,n){e?s.status(INTERNAL_SERVER_ERROR).send("Something went wrong"):(o.password=n,o.save(function(e,n){e?s.status(INTERNAL_SERVER_ERROR).send("Something went wrong"):s.status(SUCCESS).send(token)}))})}})});case 1:case"end":return e.stop()}})},exports.login=function(s,i){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:doctorModel.findOne({mobile_no:s.body.mobile_no},function(e,t){e?i.status(INTERNAL_SERVER_ERROR).send("Something went wrong"):t?bcrypt.compare(s.body.password,t.password,function(e,n){if(e)i.status(INTERNAL_SERVER_ERROR).send("Something went wrong");else{var o={mobile_no:t.mobile_no,name:t.name,reg_number:t.reg_number},r=jwt.sign(o,process.env.SECRET);doctorModel.updateOne({mobile_no:s.body.mobile_no},{session_token:r},function(e,n){e?i.status(INTERNAL_SERVER_ERROR).send("Something went wrong"):i.status(SUCCESS).send(r)})}}):i.status(DATA_NOT_FOUND).send("No such user found")});case 1:case"end":return e.stop()}})},exports.reference=function(r,t){return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:doctorModel.findOne({mobile_no:r.body.doctor},function(e,n){if(e)t.status(INTERNAL_SERVER_ERROR).send("Something went wrong");else if(n)t.status(BAD_REQUEST).send("The doctor has already registered");else{var o=new referenceModel;o.referrer=r.mobile_no,o.doctor=r.body.doctor,o.save(function(e,n){e?t.status(INTERNAL_SERVER_ERROR).send("Something went wrong"):t.status(SUCCESS).send("Successfully referred")})}});case 1:case"end":return e.stop()}})},exports.appointment=function(n,o){var r;return regeneratorRuntime.async(function(e){for(;;)switch(e.prev=e.next){case 0:r=new Date,appointmentModel.find({doc_mobile_no:n.mobile_no,appointment_date:r},function(e,n){e?o.status(INTERNAL_SERVER_ERROR).send("Internal server error"):o.status(SUCCESS).send(n)});case 2:case"end":return e.stop()}})};